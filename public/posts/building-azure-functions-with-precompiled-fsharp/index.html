<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Building Azure Functions With Precompiled F# · Discard Changes
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Mike Sigsworth">
<meta name="description" content="Previously we looked at Building Azure Functions with F# Script, which is still the only supported way of creating an Azure Function with F#, and a decent option for simple functions. So, if you need to play it safe (and stable) then that&rsquo;s your best bet. However, in this post we are going to take a trip to the edge. We&rsquo;ll be using .NET Core, Azure Functions Core Tools v2, and F#.">
<meta name="keywords" content="blog,developer,personal,dotnet,kubernetes,terraform,powershell,octopus,github,actions,c#">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building Azure Functions With Precompiled F#"/>
<meta name="twitter:description" content="Previously we looked at Building Azure Functions with F# Script, which is still the only supported way of creating an Azure Function with F#, and a decent option for simple functions. So, if you need to play it safe (and stable) then that&rsquo;s your best bet. However, in this post we are going to take a trip to the edge. We&rsquo;ll be using .NET Core, Azure Functions Core Tools v2, and F#."/>

<meta property="og:title" content="Building Azure Functions With Precompiled F#" />
<meta property="og:description" content="Previously we looked at Building Azure Functions with F# Script, which is still the only supported way of creating an Azure Function with F#, and a decent option for simple functions. So, if you need to play it safe (and stable) then that&rsquo;s your best bet. However, in this post we are going to take a trip to the edge. We&rsquo;ll be using .NET Core, Azure Functions Core Tools v2, and F#." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://discardchanges.com/posts/building-azure-functions-with-precompiled-fsharp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-04-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-04-29T00:00:00+00:00" />




<link rel="canonical" href="https://discardchanges.com/posts/building-azure-functions-with-precompiled-fsharp/">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css" integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/img/favicon-black-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/img/favicon-black-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Discard Changes
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/contact/">Contact me</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://discardchanges.com/posts/building-azure-functions-with-precompiled-fsharp/">
              Building Azure Functions With Precompiled F#
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2018-04-29T00:00:00Z">
                April 29, 2018
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              12-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/azure/">Azure</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/fsharp/">FSharp</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/azure-functions/">Azure Functions</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/visual-studio-code/">Visual Studio Code</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>Previously we looked at <a href="../building-azure-functions-with-fsharp-and-vscode" >Building Azure Functions with F# Script</a>, which is still the only <em>supported</em> way of creating an Azure Function with F#, and a decent option for simple functions. So, if you need to play it safe (and stable) then that&rsquo;s your best bet. However, in this post we are going to take a trip to the edge. We&rsquo;ll be using .NET Core, Azure Functions Core Tools v2, and F#. However, instead of F# <em>Script</em> we&rsquo;ll be creating a <em>precompiled</em> app!</p>
<p>Being on the bleeding edge has its drawbacks however. Chances are we&rsquo;re going to see some bugs. The Core Tools are in beta after all, so that should be expected. I will explain how I work around the current issues, but chances are things will change between now and the time you read this. So if you <em>don&rsquo;t</em> encounter an issue we&rsquo;re solving here, that&rsquo;s fantastic. It means Azure Functions with F# is moving in the right direction!</p>
<p>So without further ado, let&rsquo;s get started.</p>
<h2 id="setup-your-environment">
  Setup Your Environment
  <a class="heading-link" href="#setup-your-environment">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>If you&rsquo;re not already setup for F# Azure Functions development, you can follow the same instructions <a href="../building-azure-functions-with-fsharp-and-vscode/1-setup/" >from my previous post</a>, <em>with one exception</em>. You will need to install v2 instead of v1 of the Azure Functions Core Tools. I would recommend you install it with npm instead of Chocolatey. I had some issues using the Chocolatey version and never got to the bottom of it.</p>
<p>To install v2 of the Core Tools use this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">npm i -g azure-functions-core-tools@core --unsafe-perm <span class="nb">true</span>
</span></span></code></pre></div><p>Also, did I say &ldquo;one exception&rdquo;? I meant two. You&rsquo;ll also need to <a href="https://www.microsoft.com/net/learn/get-started/windows#install"  class="external-link" target="_blank" rel="noopener">install the .NET Core SDK</a>.</p>
<p>Okay&hellip; <em>three</em>. Sheesh. I&rsquo;m also going to use the <a href="https://github.com/jmrog/vscode-nuget-package-manager"  class="external-link" target="_blank" rel="noopener">NuGet Package Manager</a> extension in Visual Studio Code, so you might as well install that now as well.</p>
<div class="notice note">
  <div class="notice-title">
    <i class="fa fa-sticky-note" aria-hidden="true"></i>Note
  </div>
  <div class="notice-content">You could use Paket to manage the dependencies instead of NuGet. It&rsquo;s far more popular within the F# community. But I want to limit the number of new technologies for newcomers to F# in these posts. I&rsquo;ll get to Paket one day.</div>
</div>

<h2 id="create-the-function-app">
  Create The Function App
  <a class="heading-link" href="#create-the-function-app">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Now that you have what you need, let&rsquo;s create our app. There is no F# template available yet, so we&rsquo;re going to cheat a little and use the C# template and just change a few things. Here we go&hellip;</p>
<ul>
<li>Create a new directory (call it what you want)</li>
<li>Open VS Code</li>
<li>Invoke <code>Azure Functions: Create New Project</code> in the Command Pallette</li>
<li>Follow the prompts:
<ul>
<li><strong>Select the folder that will contain your function app:</strong> Press [Enter] to pick the current folder</li>
<li><strong>Select a language for your function project:</strong> Pick C#</li>
</ul>
</li>
</ul>
<p>You now have an empty Function App, initialized as a git repository. There&rsquo;s a <code>.gitignore</code> file tailor-made for Azure Functions development.</p>
<p>The first thing we should do is rename the <code>.csproj</code> to <code>.fsproj</code>. While you&rsquo;re in there, notice that we&rsquo;re using the new project file format, as well as <code>netstandard2.0</code>.</p>
<p>Besides the Git repo and project file, there are actually quite a few goodies nestled in the <code>.vscode</code> folder.</p>
<h3 id="vs-code-goodies">
  VS Code Goodies
  <a class="heading-link" href="#vs-code-goodies">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The C# template is configured for making Azure Functions development in VS Code an awesome experience. However, not all of it is going to help us with F#. So let&rsquo;s crack open each of these configuration files and see what we need to change. Expand the <code>.vscode</code> folder in VS Code, and let&rsquo;s dig in.</p>
<h4 id="extensionsjson">
  extensions.json
  <a class="heading-link" href="#extensionsjson">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>This file tells VS Code what extensions to recommend for the project. Obviously, we won&rsquo;t be needing the <strong>ms-vscode.csharp</strong> extension, so you can remove it.</p>
<h4 id="launchjson">
  launch.json
  <a class="heading-link" href="#launchjson">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Here we find a configuration that allows us to attach a debugger to our function. How awesome is that! Also, you should rename <strong>C#</strong> to <strong>F#</strong> in the <code>name</code> field. Sure it&rsquo;s a minor detail, but those who know me know I can&rsquo;t live with these kind of inconsistencies! I feel better now. Do you?</p>
<h4 id="settingsjson">
  settings.json
  <a class="heading-link" href="#settingsjson">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>This is where you customize VS Code&rsquo;s workspace settings. In this case, there&rsquo;s some configuration for the Azure Functions extension. We <em>should</em> change <code>azureFunctions.projectLanguage</code> to <code>F#</code>. However, it might be useful to leave this alone so we can generate new Functions based on their C# templates and simply port them to F#. I&rsquo;ll leave this decision up to you.</p>
<h4 id="tasksjson">
  tasks.json
  <a class="heading-link" href="#tasksjson">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Last, <em>but certainly not least,</em> are the three tasks that allow you to <strong>clean</strong>, <strong>build</strong>, and <strong>run</strong> your Function App from the VS Code Command Palette. Or, if you prefer, using the following keyboard shortcuts:</p>
<ul>
<li><strong>build:</strong> <code>Ctrl+Shift+B</code>.</li>
<li><strong>Run Functions Host:</strong> <code>Ctrl+Shift+R</code> (with a <a href="/post/building-azure-functions-with-fsharp-and-vscode/3-running-locally/#create-a-custom-keybinding" >custom keybinding</a>)</li>
</ul>
<h2 id="if-you-build-it-they-will-oh">
  If You Build It, They Will&hellip; Oh
  <a class="heading-link" href="#if-you-build-it-they-will-oh">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>If you attempt to build the app now, you might see the following warning in the terminal. If not, feel free to skip this section.</p>
<blockquote>
<p>warning NU1701: Package &lsquo;Microsoft.AspNet.WebApi.Client 5.2.2&rsquo; was restored using &lsquo;.NETFramework,Version=v4.6.1&rsquo; instead of the project target framework &lsquo;.NETStandard,Version=v2.0&rsquo;. This package may not be fully compatible with your project.</p>
</blockquote>
<p>To fix this, we&rsquo;ll need to update our version of <strong>Microsoft.NET.Sdk.Functions</strong>. Open the Command Palette and invoke <code>NuGet Package Manager: Add Package</code> and search for <strong>Microsoft.NET.Sdk.Functions</strong>. Select the latest version and continue. When I wrote this, the latest version was <strong>1.0.13</strong>.</p>
<p>Once that completes you should be able to build without warnings.</p>
<h2 id="create-a-function">
  Create a Function
  <a class="heading-link" href="#create-a-function">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>As mentioned above, there are no F# templates yet. So the Azure Functions extension can&rsquo;t help us to create a new F# function. If you chose not to change <code>azureFunctions.projectLanguage</code> to <code>F#</code> in the <code>settings.json</code>, then you <em>could</em> generate one in C# and convert it. But that&rsquo;s not what we&rsquo;re going to do. We&rsquo;ll learn more by creating one from scratch.</p>
<p>We will use the new <strong>Attributed Model</strong> to define our function. This means we don&rsquo;t have to manage the <code>function.json</code> file anymore. It&rsquo;s generated at compile time based on the attributes! Full disclosure, the attributes are kinda ugly, but we&rsquo;ll explore <a href="./#let-s-deal-with-those-attributes" >a strategy to deal with that</a> later.</p>
<p>Like <a href="../building-azure-functions-with-fsharp-and-vscode/2-create-function-app/" >last time</a>, we&rsquo;re going to create an <strong>HttpTrigger</strong> function called <strong>HelloYou</strong>. Start by create a new file at the root of your project called <code>HelloYou.fs</code>. You&rsquo;ll have to add a reference to the new file in your <code>.fsproj</code>. The Ionide plugin provides a quick way to do this via the <code>F#: Add Current File To Project</code> command. However, when I wrote this it wasn&rsquo;t working. So make sure to check the project file has this added to it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="nt">&lt;ItemGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&#34;HelloYou.fs&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><p>Add the following code to <code>HelloYou.fs</code>. We&rsquo;re going to keep things simple for now and just echo back &ldquo;Hello&rdquo;. It&rsquo;s a start.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MyFunctions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Azure.WebJobs</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Mvc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">HelloYou</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="o">[&lt;</span><span class="n">FunctionName</span><span class="o">(</span><span class="s">&#34;HelloYou&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">run</span>
</span></span><span class="line"><span class="cl">        <span class="o">([&lt;</span><span class="n">HttpTrigger</span><span class="o">(</span><span class="nn">Extensions</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nn">AuthorizationLevel</span><span class="p">.</span><span class="n">Anonymous</span><span class="o">,</span> <span class="s">&#34;get&#34;</span><span class="o">,</span> <span class="n">Route</span> <span class="o">=</span> <span class="s">&#34;hello&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">        <span class="n">req</span><span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">ContentResult</span><span class="o">(</span><span class="n">Content</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="o">,</span> <span class="n">ContentType</span> <span class="o">=</span> <span class="s">&#34;text/html&#34;</span><span class="o">)</span>
</span></span></code></pre></div><h3 id="check-out-those-ugly-attributes">
  Check out those ugly attributes
  <a class="heading-link" href="#check-out-those-ugly-attributes">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Personally, I think the attributes are kinda ugly. But their inner beauty is not have to maintain a <code>function.json</code>. Let&rsquo;s take a quick peek at the two we&rsquo;re using here.</p>
<h4 id="functionname">
  FunctionName
  <a class="heading-link" href="#functionname">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>The <code>FunctionName</code> attribute marks this as a function entry point. This name must be unique within your Function App. It also let&rsquo;s you name the function in code whatever you want, e.g. <code>run</code>.</p>
<h4 id="httptrigger">
  HttpTrigger
  <a class="heading-link" href="#httptrigger">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>All functions need to be triggered somehow. In our case, we&rsquo;re using the <code>HttpTrigger</code> attribute to indicate this function is triggered by an HTTP call. It takes several parameters:</p>
<ul>
<li><strong>authLevel:</strong> Sets the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook#authorization-keys"  class="external-link" target="_blank" rel="noopener">authorization level</a> for the function, i.e. what keys need to be provided to invoke the function.</li>
<li><strong>methods:</strong> Indicates which HTTP verbs the function is triggered by. In our case we&rsquo;re just using GET</li>
<li><strong>route:</strong> The route to our function</li>
</ul>
<h2 id="if-you-run-it-they-will-oh">
  If You Run It, They Will&hellip; Oh
  <a class="heading-link" href="#if-you-run-it-they-will-oh">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I liked that heading so much I thought I&rsquo;d reuse it for our second gotcha!</p>
<p>If you run function, you <em>might</em> see the following error:</p>
<blockquote>
<p>System.Private.CoreLib: Could not load file or assembly &lsquo;FSharp.Core, Version=4.4.3.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&rsquo;. Could not find or load a specific file.</p>
</blockquote>
<p>If you don&rsquo;t see this, fantastic! Move on to the next section. But if you do&hellip;
This is caused by an assembly version mismatch in the Azure Functions Core Tools runtime. In this case, it&rsquo;s the <strong>FSharp.Core</strong> assembly. Like you, I am using the latest F# version on my machine, so our app is attempting to load <code>FSharp.Core, Version=4.4.3.0</code>. But the Azure Functions runtime has only loaded <strong>v4.2.3</strong>. To fix this, we will install the <strong>FSharp.Core</strong> NuGet package for the version used by the Azure Functions runtime.</p>
<p>Stop the Function Host if it&rsquo;s still running (press <code>Ctrl+C</code> in the terminal). Then invoke the <code>NuGet Package Manager: Add Package</code> command and find <code>FSharp.Core</code>. Install version <strong>4.2.3</strong>. Once complete you should see a new <code>PackageReference</code> in the <code>.fsproj</code> for <strong>FSharp.Core</strong>.</p>
<h2 id="if-you-run-it-it-will-run">
  If You Run It, It Will&hellip; Run!
  <a class="heading-link" href="#if-you-run-it-it-will-run">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Okay, <em>NOW</em> you can start the function host and everything should be just hunky dory. If you <code>Ctrl+Click</code> the HelloYou link <a href="http://localhost:7071/api/hello"  class="external-link" target="_blank" rel="noopener">http://localhost:7071/api/hello</a> in the terminal window your browser should open up a page that says &ldquo;Hello&rdquo;.</p>
<p>Amazing! Look at us fancy programmers with our &ldquo;Hello&rdquo; string. But we can do better&hellip;</p>
<h2 id="lets-deal-with-those-attributes">
  Let&rsquo;s Deal With Those Attributes
  <a class="heading-link" href="#lets-deal-with-those-attributes">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I think I read somewhere that it&rsquo;s a good practice to keep the attributed function declarations separate from your actual code. But in case I&rsquo;m imagining that, then you can say you read it here first.</p>
<p>Let&rsquo;s create a <code>Functions.fs</code> file at the root of our project and put our attributed function there. Don&rsquo;t forget to update the <code>.fsproj</code>.</p>
<h3 id="functionsfs">
  Functions.fs
  <a class="heading-link" href="#functionsfs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MyFunctions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Azure.WebJobs</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Functions</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[&lt;</span><span class="n">FunctionName</span><span class="o">(</span><span class="s">&#34;HelloYou&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">helloYou</span>
</span></span><span class="line"><span class="cl">        <span class="o">([&lt;</span><span class="n">HttpTrigger</span><span class="o">(</span><span class="nn">Extensions</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nn">AuthorizationLevel</span><span class="p">.</span><span class="n">Anonymous</span><span class="o">,</span> <span class="s">&#34;get&#34;</span><span class="o">,</span> <span class="n">Route</span> <span class="o">=</span> <span class="s">&#34;hello&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">        <span class="n">req</span><span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="nn">HelloYou</span><span class="p">.</span><span class="n">run</span> <span class="n">req</span>
</span></span></code></pre></div><h3 id="fsproj">
  fsproj
  <a class="heading-link" href="#fsproj">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The ordering here is important!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="nt">&lt;ItemGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&#34;HelloYou.fs&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Compile</span> <span class="na">Include=</span><span class="s">&#34;Functions.fs&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><h3 id="helloyoufs">
  HelloYou.fs
  <a class="heading-link" href="#helloyoufs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MyFunctions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Mvc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">HelloYou</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">run</span> <span class="o">(</span><span class="n">req</span><span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">ContentResult</span><span class="o">(</span><span class="n">Content</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="o">,</span> <span class="n">ContentType</span> <span class="o">=</span> <span class="s">&#34;text/html&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>Now that the Azure Functions stuff is separated, we are free to write more canonical F# in our <code>HelloYou.fs</code>.
Make sure you run the function again to make sure it still works.</p>
<h2 id="this-isnt-even-my-final-form">
  This Isn&rsquo;t Even My Final Form
  <a class="heading-link" href="#this-isnt-even-my-final-form">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Now that we&rsquo;ve got things running, and we&rsquo;ve shunted our attributes to a separate file, let&rsquo;s fill out the rest of our function!</p>
<div class="notice note">
  <div class="notice-title">
    <i class="fa fa-sticky-note" aria-hidden="true"></i>Note
  </div>
  <div class="notice-content">Instead of copy/pasting the code below, try writing it yourself. Use the auto-open feature of Ionide to automatically add the necessary <code>open</code> statements for your code. Simply write part of the identifier, e.g. <code>TraceWr</code> and when the intellisense suggests: <img src="img/auto-open-intellisense.png" alt="Auto-Open Intellisense"> hit <strong>[Enter]</strong> to complete the statement and add the <code>open</code> statement at the top of the file.</div>
</div>

<h3 id="changes-to-functionsfs">
  Changes to Functions.fs
  <a class="heading-link" href="#changes-to-functionsfs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>We&rsquo;re going to add some logging to our function. So we&rsquo;ll need to add a <code>log: TraceWriter</code> parameter to our function declaration. We&rsquo;re also going to use HTTP POST instead of GET, so we&rsquo;ll need to update the list of supported <code>methods</code>.</p>
<p>Our <code>Functions.fs</code> now looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MyFunctions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Azure.WebJobs</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Azure.WebJobs.Host</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Functions</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[&lt;</span><span class="n">FunctionName</span><span class="o">(</span><span class="s">&#34;HelloYou&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">helloYou</span>
</span></span><span class="line"><span class="cl">        <span class="o">([&lt;</span><span class="n">HttpTrigger</span><span class="o">(</span><span class="nn">Extensions</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nn">AuthorizationLevel</span><span class="p">.</span><span class="n">Anonymous</span><span class="o">,</span> <span class="s">&#34;post&#34;</span><span class="o">,</span> <span class="n">Route</span> <span class="o">=</span> <span class="s">&#34;hello&#34;</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl">        <span class="n">req</span><span class="o">:</span> <span class="n">HttpRequest</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">:</span> <span class="n">TraceWriter</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="nn">HelloYou</span><span class="p">.</span><span class="n">run</span> <span class="n">req</span> <span class="n">log</span>
</span></span></code></pre></div><h3 id="changes-to-helloyoufs">
  Changes to HelloYou.fs
  <a class="heading-link" href="#changes-to-helloyoufs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The <code>HelloYou.run</code> function itself is going to have a number of changes.</p>
<ul>
<li>We&rsquo;re adding the ability to take some input JSON, which needs to be deserialized. For that, we define a new record type called <code>InputModel</code></li>
<li>We&rsquo;ll then read the <code>req.Body</code> using a <code>StreamReader</code></li>
<li>Deserialize the input with <code>JsonConvert.DeserializeObject</code></li>
<li>Do some quick validation of the input to ensure both <strong>FirstName</strong> and <strong>LastName</strong> are provided</li>
<li>If our validation fails we return a <code>BadRequestObjectResult</code></li>
<li>Otherwise we return an <code>OkObjectResult</code> with our response</li>
<li>We&rsquo;ve also added some logging, and wrapped the whole thing in an async workflow</li>
</ul>
<div class="notice note">
  <div class="notice-title">
    <i class="fa fa-sticky-note" aria-hidden="true"></i>Note
  </div>
  <div class="notice-content">Notice that we have to cast these responses to the same result type using <code>:&gt; IActionResult</code> in order to appease the F# compiler.</div>
</div>

<p>Our <code>HelloYou.fs</code> now looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MyFunctions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Mvc</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Azure.WebJobs.Host</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">System.IO</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Newtonsoft.Json</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">System</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">HelloYou</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">type</span> <span class="nc">InputModel</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FirstName</span><span class="o">:</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="n">LastName</span><span class="o">:</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">exception</span> <span class="n">InvalidInputException</span> <span class="k">of</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">run</span> <span class="o">(</span><span class="n">req</span><span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">(</span><span class="n">log</span><span class="o">:</span> <span class="n">TraceWriter</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">Info</span> <span class="s">&#34;[Enter] HelloYou.run&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">async</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">use</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">Body</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">let!</span> <span class="nv">body</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">ReadToEndAsync</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">AwaitTask</span>
</span></span><span class="line"><span class="cl">            <span class="k">let</span> <span class="nv">input</span> <span class="o">=</span> <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="o">&lt;</span><span class="n">InputModel</span><span class="o">&gt;(</span><span class="n">body</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span> <span class="n">input</span><span class="o">.</span><span class="n">FirstName</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span> <span class="n">input</span><span class="o">.</span><span class="n">LastName</span><span class="o">)</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="n">Info</span> <span class="s">&#34;Received by input&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">BadRequestObjectResult</span> <span class="s">&#34;Please pass a JSON object with a FirstName and a LastName.&#34;</span> <span class="o">:&gt;</span> <span class="n">IActionResult</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="n">Info</span> <span class="s">&#34;Received good input&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">OkObjectResult</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s">&#34;Hello, %s %s&#34;</span> <span class="n">input</span><span class="o">.</span><span class="n">FirstName</span> <span class="n">input</span><span class="o">.</span><span class="n">LastName</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">IActionResult</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
</span></span></code></pre></div><p>You should be able to run this locally now and test it with Postman. Here&rsquo;s what a good request looks like:</p>
<p><img src="img/postman-request.png" alt="Postman Request"></p>
<p>Notice, there is no error handling. So if you pass some invalid input you&rsquo;ll get a <strong>500 Internal Server Error</strong> back.</p>
<h2 id="a-final-note-about-the-functionjson">
  A Final Note About the <code>function.json</code>
  <a class="heading-link" href="#a-final-note-about-the-functionjson">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Without the function attributes we would&rsquo;ve needed to create and maintain a <code>function.json</code> file. Fortunately, this gets generated for us at compile time and can be found in <code>bin\Debug\netstandard2.0\HelloYou\function.json</code>. It looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;generatedBy&#34;</span><span class="p">:</span> <span class="s2">&#34;Microsoft.NET.Sdk.Functions-1.0.13&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;configurationSource&#34;</span><span class="p">:</span> <span class="s2">&#34;attributes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;bindings&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;httpTrigger&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;methods&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;post&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;authLevel&#34;</span><span class="p">:</span> <span class="s2">&#34;anonymous&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;req&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;disabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scriptFile&#34;</span><span class="p">:</span> <span class="s2">&#34;../bin/building-azure-functions-with-precompiled-fsharp.dll&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;entryPoint&#34;</span><span class="p">:</span> <span class="s2">&#34;MyFunctions.Functions.helloYou&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Notice that it calls out the fact it&rsquo;s a generated file with the <code>generatedBy</code> property. And check out those bindings. You can see in the <code>req</code> binding it lists the only method supported is <strong>post</strong>, and the <code>authLevel</code> we specified is set to <strong>anonymous</strong>. It&rsquo;s got our <code>route</code> specified there as well.</p>
<p>Two other properties, essential to a precompiled app, are listed at the end:</p>
<ul>
<li><code>scriptFile</code>: Point to the compiled assembly</li>
<li><code>entryPoint</code>: Indicates the <strong>[namespace].[module].[function]</strong> of the function, in this case <code>MyFunctions.Functions.helloYou</code></li>
</ul>
<h2 id="whats-next">
  What&rsquo;s Next
  <a class="heading-link" href="#whats-next">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>We covered a ton of ground on this one! Working with Pre-Compiled apps gives us a ton of flexibility. Also, we didn&rsquo;t need that weird <a href="../building-azure-functions-with-fsharp-and-vscode/2-create-function-app/#holy-squigglies" >Editor Prelude</a> thing. But we did lose the slickness of auto-reloading on changes that is supported by F# (and C#) Script. The good news is, that&rsquo;s been implemented already and will likely be included in the next beta release of the core tools!</p>
<p>Why not try <a href="../building-azure-functions-with-fsharp-and-vscode/4-deploy-to-azure/" >deploying this to your Azure account</a>. Once you do, notice that none of the code is editable in the Azure Portal. That&rsquo;s because it&rsquo;s a precompiled app. The only thing you&rsquo;ll see there is the generated <code>function.json</code>.</p>
<p>Oh, and try attaching the debugger to your function! Just run the function, set a breakpoint, and press <code>F5</code>. Super easy!</p>
<p>That&rsquo;s it for now. And thanks for reading!</p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "discardchanges" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2023
     Mike Sigsworth 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
