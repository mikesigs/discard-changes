<!doctype html><html lang=en><head><title>Creating a Terraform Version Manager with PowerShell · Discard Changes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mike Sigsworth"><meta name=description content="Build a Terraform version manager in PowerShell to easily switch between different versions of Terraform on Windows."><meta name=keywords content="blog,developer,personal,dotnet,kubernetes,terraform,powershell,octopus,github,actions,c#"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating a Terraform Version Manager with PowerShell"><meta name=twitter:description content="Build a Terraform version manager in PowerShell to easily switch between different versions of Terraform on Windows."><meta property="og:title" content="Creating a Terraform Version Manager with PowerShell"><meta property="og:description" content="Build a Terraform version manager in PowerShell to easily switch between different versions of Terraform on Windows."><meta property="og:type" content="article"><meta property="og:url" content="https://discardchanges.com/posts/terraform-version-manager/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-21T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-21T00:00:00+00:00"><link rel=canonical href=https://discardchanges.com/posts/terraform-version-manager/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/img/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-black-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-black-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Discard Changes</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://discardchanges.com/posts/terraform-version-manager/>Creating a Terraform Version Manager with PowerShell</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-03-21T00:00:00Z>March 21, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
9-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/terraform/>terraform</a>
<span class=separator>•</span>
<a href=/categories/powershell/>powershell</a>
<span class=separator>•</span>
<a href=/categories/cli/>cli</a>
<span class=separator>•</span>
<a href=/categories/devex/>devex</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/terraform/>terraform</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/powershell/>powershell</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/windows/>windows</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/hashicorp/>hashicorp</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/tfv/>tfv</a></span></div></div></header><div class=post-content><p>If you&rsquo;re a developer who works with Terraform, you know how important it is to have the right version of Terraform installed for your project. But what if you need to work on multiple projects, each with a different version of Terraform? That&rsquo;s where a Terraform version manager comes in.</p><p>There are a couple Terraform version managers available for Linux and Mac, including:</p><ul><li><a href=https://github.com/tfutils/tfenv class=external-link target=_blank rel=noopener>tfenv</a></li><li><a href=https://github.com/warrensbox/terraform-switcher class=external-link target=_blank rel=noopener>tfswitch</a></li></ul><p>These tools allow you to easily switch between different versions of Terraform on your local machine. These tools are great if you&rsquo;re using Linux or Mac, or if you&rsquo;re using WSL on Windows. However, there are very few options available for those who prefer to use PowerShell on Windows.</p><p>In this post, we&rsquo;ll walk through how to write a Terraform Version Manager in PowerShell. We&rsquo;ll cover all the essential functionality so you&rsquo;ll have a comprehensive and user-friendly tool at your disposal.</p><h2 id=overview>Overview
<a class=heading-link href=#overview><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Before we dive into the actual code, let&rsquo;s take a look at the basic functionality we&rsquo;ll need to implement:</p><ul><li>List available versions on the HashiCorp website</li><li>Install/uninstall a specific version</li><li>Set/unset the active version</li><li>List our installed versions</li><li>Show the active version</li></ul><h2 id=lets-get-started>Let&rsquo;s Get Started
<a class=heading-link href=#lets-get-started><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>First things first, we&rsquo;ll create a new file called <code>tfv.ps1</code> in the same directory as our Powershell profile and open it in our favourite editor.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$ScriptPath</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nb>Split-Path</span> <span class=n>-Path</span> <span class=nv>$PROFILE</span> <span class=n>-Parent</span><span class=p>)</span><span class=s2>\tfv.ps1&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>New-Item</span> <span class=n>-Path</span> <span class=nv>$ScriptPath</span> <span class=n>-ItemType</span> <span class=n>File</span>
</span></span><span class=line><span class=cl><span class=n>code</span> <span class=nv>$ScriptPath</span>
</span></span></code></pre></div><p>We need a place to store the Terraform binaries we&rsquo;ll be installing, as well as a file to keep track of the current version. Let&rsquo;s use a few variables to keep track of these paths. We&rsquo;ll also ensure that these directories exist each time the script runs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$TfvBaseDirectory</span> <span class=p>=</span> <span class=s2>&#34;~/.tfv/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$TfvInstallDirectory</span> <span class=p>=</span> <span class=s2>&#34;~/.tfv/versions&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$TfvCurrentVersionFile</span> <span class=p>=</span> <span class=s2>&#34;~/.tfv/current&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$TfvBaseDirectory</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>New-Item</span> <span class=n>-ItemType</span> <span class=n>Directory</span> <span class=n>-Path</span> <span class=nv>$TfvBaseDirectory</span> <span class=p>|</span> <span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$TfvInstallDirectory</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>New-Item</span> <span class=n>-ItemType</span> <span class=n>Directory</span> <span class=n>-Path</span> <span class=nv>$TfvInstallDirectory</span> <span class=p>|</span> <span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=listing-the-available-versions-from-hashicorp>Listing the Available Versions from Hashicorp
<a class=heading-link href=#listing-the-available-versions-from-hashicorp><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The first function we&rsquo;ll need is one that can list the available versions of Terraform on the HashiCorp website. This function will make an HTTP request to their <a href=https://releases.hashicorp.com/terraform class=external-link target=_blank rel=noopener>Releases</a> page, then parse the HTML to get a list of version numbers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Show-TerraformVersions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Response</span> <span class=p>=</span> <span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=s2>&#34;https://releases.hashicorp.com/terraform&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TerraformVersions</span> <span class=p>=</span> <span class=p>[</span><span class=no>Regex</span><span class=p>]::</span><span class=n>Matches</span><span class=p>(</span><span class=nv>$Response</span><span class=p>.</span><span class=n>Content</span><span class=p>,</span> <span class=s1>&#39;&lt;a href=&#34;.+&#34;&gt;terraform_(.+)&lt;/a&gt;&#39;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=p>{</span> <span class=nv>$_</span><span class=p>.</span><span class=n>Groups</span><span class=p>[</span><span class=mf>1</span><span class=p>].</span><span class=py>Value</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TerraformVersions</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class="notice note"><div class=notice-title><i class="fa fa-sticky-note" aria-hidden=true></i>Note</div><div class=notice-content>I couldn&rsquo;t find a JSON API with a list of available versions, so we&rsquo;re just parsing the HTML. If you know a better way to do this, let me know in the comments!</div></div><h2 id=installing-a-specific-version>Installing a Specific Version
<a class=heading-link href=#installing-a-specific-version><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now that we can retrieve a list of available versions, we need a function to install one. The Terraform releases are just zip files containing a single binary, so all we need to do is download the file, extract the binary, and place it in a version-specific directory in <code>~/.tfv/versions/</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Install-Terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$true</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span> <span class=nv>$Version</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$TempFile</span> <span class=p>=</span> <span class=nb>New-TemporaryFile</span> <span class=p>|</span> <span class=nb>Rename-Item</span> <span class=n>-NewName</span> <span class=p>{</span> <span class=nv>$_</span> <span class=o>-replace</span> <span class=s1>&#39;tmp$&#39;</span><span class=p>,</span> <span class=s1>&#39;zip&#39;</span> <span class=p>}</span> <span class=err>–</span><span class=n>PassThru</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Url</span> <span class=p>=</span> <span class=s2>&#34;https://releases.hashicorp.com/terraform/</span><span class=nv>$Version</span><span class=s2>/terraform_</span><span class=p>$(</span><span class=nv>$Version</span><span class=p>)</span><span class=s2>_windows_amd64.zip&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=nv>$Url</span> <span class=n>-OutFile</span> <span class=nv>$TempFile</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TempFile</span> <span class=p>|</span> <span class=nb>Expand-Archive</span> <span class=n>-DestinationPath</span> <span class=s2>&#34;</span><span class=nv>$TfvInstallDirectory</span><span class=s2>/</span><span class=nv>$Version</span><span class=s2>&#34;</span> <span class=n>-Force</span> <span class=p>|</span> <span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TempFile</span> <span class=p>|</span> <span class=nb>Remove-Item</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=setting-the-active-version>Setting the Active Version
<a class=heading-link href=#setting-the-active-version><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Next we need a way to indicate which version we want to use. Let&rsquo;s create a function that takes a version number as a parameter. It will create an alias for the <code>terraform</code> command that points to the indicated version of the Terraform binary. We&rsquo;ll also keep track of the active version in the <code>~/.tfv/current</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Set-ActiveTerraformVersion</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$true</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span> <span class=nv>$Version</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Check if the specified Terraform version is installed</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TerraformPath</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$TfvInstallDirectory</span><span class=s2>/</span><span class=nv>$Version</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$TerraformPath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=s2>&#34;Terraform version </span><span class=nv>$Version</span><span class=s2> not installed&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Store the active version in a file so it will persist between sessions</span>
</span></span><span class=line><span class=cl>    <span class=nb>Set-Content</span> <span class=n>-Path</span> <span class=nv>$TfvCurrentVersionFile</span> <span class=n>-Value</span> <span class=nv>$Version</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Create aliases for the Terraform executable</span>
</span></span><span class=line><span class=cl>    <span class=nb>Set-Alias</span> <span class=n>-Name</span> <span class=n>terraform</span> <span class=n>-Value</span> <span class=s2>&#34;</span><span class=nv>$TerraformPath</span><span class=s2>/terraform.exe&#34;</span> <span class=n>-Scope</span> <span class=n>Global</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class="notice info"><div class=notice-title><i class="fa fa-exclamation-circle" aria-hidden=true></i>Info</div><div class=notice-content>You <em>could</em> stop here. This is all you really need to install and switch between different versions of Terraform. But we can do better. Let&rsquo;s add a few more functions to make this tool even more useful.</div></div><h2 id=displaying-the-active-version>Displaying the Active Version
<a class=heading-link href=#displaying-the-active-version><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In order to display the active version of Terraform we just need to read the value from the <code>~/.tfv/current</code> file. If the file doesn&rsquo;t exist, that means no version has been set, so we&rsquo;ll return <code>$null</code> and display a helpful warning message.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-ActiveTerraformVersion</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$TfvCurrentVersionFile</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Warning</span> <span class=s1>&#39;No active Terraform version set! Use `tfv set &lt;version&gt;` to set the active version.&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>Get-Content</span> <span class=n>-Path</span> <span class=nv>$TfvCurrentVersionFile</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class="notice warning"><div class=notice-title><i class="fa fa-exclamation-triangle" aria-hidden=true></i>Warning</div><div class=notice-content>You could use the <code>terraform -v</code> command directly, but when there is no active version the <code>terraform</code> alias will not exist. So invoking it will fail with an unfriendly error message. We want to display a helpful message instead.</div></div><h2 id=listing-installed-versions>Listing Installed Versions
<a class=heading-link href=#listing-installed-versions><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We&rsquo;ll definitely need a way to see what we already have installed. For this we&rsquo;ll modify the <code>Show-TerraformVersions</code> function we created earlier by adding a <code>-LocalOnly</code> switch. When the switch is set, we&rsquo;ll simply need to list the contents of the <code>~/.tfv/versions/</code> directory. We&rsquo;ll also highlight the active version if one is set.</p><p>Replace the <code>Show-TerraformVersions</code> function with the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Show-TerraformVersions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$false</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>switch</span><span class=p>]</span> <span class=nv>$LocalOnly</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$LocalOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$TerraformVersions</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=nb>Get-ChildItem</span> <span class=s2>&#34;</span><span class=nv>$TfvInstallDirectory</span><span class=s2>&#34;</span> <span class=n>-Directory</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-ExpandProperty</span> <span class=n>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$TerraformVersions</span><span class=p>.</span><span class=py>Count</span> <span class=o>-eq</span> <span class=mf>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=s1>&#39;No Terraform versions installed! Use `tfv install &lt;version&gt;` to install a new version.&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$Response</span> <span class=p>=</span> <span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=s2>&#34;https://releases.hashicorp.com/terraform&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$TerraformVersions</span> <span class=p>=</span> <span class=p>[</span><span class=no>Regex</span><span class=p>]::</span><span class=n>Matches</span><span class=p>(</span><span class=nv>$Response</span><span class=p>.</span><span class=n>Content</span><span class=p>,</span> <span class=s1>&#39;&lt;a href=&#34;.+&#34;&gt;terraform_(.+)&lt;/a&gt;&#39;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=p>{</span> <span class=nv>$_</span><span class=p>.</span><span class=n>Groups</span><span class=p>[</span><span class=mf>1</span><span class=p>].</span><span class=py>Value</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$ActiveVersion</span> <span class=p>=</span> <span class=nb>Get-ActiveTerraformVersion</span>
</span></span><span class=line><span class=cl>    <span class=nv>$TerraformVersions</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$_</span> <span class=o>-eq</span> <span class=nv>$ActiveVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Write-Host</span> <span class=s2>&#34;* </span><span class=nv>$_</span><span class=s2>&#34;</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Write-Host</span> <span class=s2>&#34;  </span><span class=nv>$_</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=uninstalling-a-version>Uninstalling a Version
<a class=heading-link href=#uninstalling-a-version><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>To complete our Terraform Version Switcher we need to have a way to uninstall a version we&rsquo;re no longer using. We&rsquo;ll also make sure to unset the active version if we&rsquo;re uninstalling it. We&rsquo;ll split this functionality into two functions: <code>Remove-ActiveTerraformVersion</code> and <code>Uninstall-Terraform</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Remove-ActiveTerraformVersion</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Remove-Alias</span> <span class=n>-Name</span> <span class=n>terraform</span> <span class=n>-Scope</span> <span class=n>Global</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Uninstall-Terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$true</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span> <span class=nv>$Version</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>$TfvInstallDirectory</span><span class=s2>/</span><span class=nv>$Version</span><span class=s2>&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=s2>&#34;Terraform version </span><span class=nv>$Version</span><span class=s2> not installed!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$Version</span> <span class=o>-eq</span> <span class=p>(</span><span class=nb>Get-ActiveTerraformVersion</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>Remove-ActiveTerraformVersion</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=nv>$TfvInstallDirectory</span><span class=s2>/</span><span class=nv>$Version</span><span class=s2>&#34;</span> <span class=n>-Recurse</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=creating-a-single-entry-point>Creating a Single Entry Point
<a class=heading-link href=#creating-a-single-entry-point><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point we have everything we need to <code>install</code>, <code>uninstall</code>, <code>list</code>, <code>set</code>, and <code>unset</code> different versions of Terraform. But who&rsquo;s going to remember all those functions? Not to mention the verbosity of typical PowerShell function names! What we need is a single command to handle it all.</p><p>Let&rsquo;s create one last function (<em>with another long-winded name</em>) called <code>Invoke-TerraformVersionManager</code> and create a much needed alias <code>tfv</code> to give us a simple entrypoint to all of this functionality.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Invoke-TerraformVersionManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$false</span><span class=p>,</span> <span class=na>Position</span> <span class=p>=</span> <span class=mf>0</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;current&#34;</span><span class=p>,</span> <span class=s2>&#34;install&#34;</span><span class=p>,</span> <span class=s2>&#34;list&#34;</span><span class=p>,</span> <span class=s2>&#34;ls&#34;</span><span class=p>,</span> <span class=s2>&#34;ls-remote&#34;</span><span class=p>,</span> <span class=s2>&#34;uninstall&#34;</span><span class=p>,</span> <span class=s2>&#34;use&#34;</span><span class=p>,</span> <span class=s2>&#34;set&#34;</span><span class=p>,</span> <span class=s2>&#34;clear&#34;</span><span class=p>,</span> <span class=s2>&#34;unset&#34;</span><span class=p>,</span> <span class=s2>&#34;help&#34;</span> <span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span> <span class=nv>$Command</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span> <span class=p>=</span> <span class=vm>$false</span><span class=p>,</span> <span class=na>Position</span> <span class=p>=</span> <span class=mf>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>string</span><span class=p>]</span> <span class=nv>$Arg</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># Default to &#34;current&#34; if no command is specified</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>([</span><span class=no>String</span><span class=p>]::</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=nv>$Command</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$Command</span> <span class=p>=</span> <span class=s2>&#34;current&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nv>$Command</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;current&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Get-ActiveTerraformVersion</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;install&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Install-Terraform</span> <span class=n>-Version</span> <span class=nv>$Arg</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=nv>$_</span> <span class=n>-in</span> <span class=s2>&#34;ls&#34;</span><span class=p>,</span> <span class=s2>&#34;list&#34;</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Get-TerraformVersions</span> <span class=n>-LocalOnly</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ls-remote&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Get-TerraformVersions</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;uninstall&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Uninstall-Terraform</span> <span class=n>-Version</span> <span class=nv>$Arg</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=nv>$_</span> <span class=n>-in</span> <span class=s2>&#34;set&#34;</span><span class=p>,</span> <span class=s2>&#34;use&#34;</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Set-ActiveTerraformVersion</span> <span class=n>-Version</span> <span class=nv>$Arg</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=nv>$_</span> <span class=n>-in</span> <span class=s2>&#34;unset&#34;</span><span class=p>,</span> <span class=s2>&#34;clear&#34;</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Remove-ActiveTerraformVersion</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;help&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>Show-Help</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=s2>&#34;Invalid command: </span><span class=nv>$Command</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Set-Alias</span> <span class=n>tfv</span> <span class=nb>Invoke-TerraformVersionManager</span>
</span></span></code></pre></div><h2 id=showing-help-documentation>Showing Help Documentation
<a class=heading-link href=#showing-help-documentation><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Oops! If you were looking closely, you may have noticed that we&rsquo;re missing a function called <code>Show-Help</code>. Let&rsquo;s add that now so we can see a helpful message when we run <code>tfv help</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Show-Help</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;Usage:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv current             &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Show the currently active Terraform version&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv install &lt;version&gt;   &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Install a new version of Terraform&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv uninstall &lt;version&gt; &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Uninstall a version of Terraform&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv ls                  &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: List all installed versions of Terraform. [alias: tfv list]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv ls-remote           &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: List all available versions of Terraform&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv set &lt;version&gt;       &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Set the active version of Terraform [alias: tfv use]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv unset               &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Unset the active version of Terraform [alias: tfv clear]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;  tfv help                &#34;</span> <span class=n>-NoNewLine</span> <span class=n>-Foreground</span> <span class=n>Cyan</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;: Show this help message&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=set-the-active-version-on-startup>Set the Active Version on Startup
<a class=heading-link href=#set-the-active-version-on-startup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>There&rsquo;s one last thing we must do before this tool is complete. Each time the script loads we need to reinitialize our <code>terraform</code> alias if there is a current version stored in the <code>~/.tfv/current</code> file. We can do this by adding the following code to the end of our script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Set the active version if one is already set</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nb>Get-ActiveTerraformVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Set-ActiveTerraformVersion</span> <span class=n>-Version</span> <span class=p>(</span><span class=nb>Get-ActiveTerraformVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=loading-the-script-into-our-powershell-profile>Loading the Script into our PowerShell Profile
<a class=heading-link href=#loading-the-script-into-our-powershell-profile><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>To use our shiny new <code>tfv</code> command, we need to add the following line to your PowerShell profile. This will ensure that the <code>tfv</code> command is available in all of our PowerShell sessions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.</span> <span class=p>([</span><span class=no>IO.Path</span><span class=p>]::</span><span class=n>Combine</span><span class=p>(</span><span class=nv>$PSScriptRoot</span><span class=p>,</span> <span class=s2>&#34;tfv.ps1&#34;</span><span class=p>))</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In this post we learned how to create a Terraform Version Manager in PowerShell. We covered all the essential functionality so we&rsquo;ll have a comprehensive and user-friendly tool at our disposal.</p><p>Here are the basic commands we can now use:</p><ul><li><code>tfv install &lt;version></code>: Install a new version of Terraform</li><li><code>tfv uninstall &lt;version></code>: Uninstall a version of Terraform</li><li><code>tfv ls</code>: List all installed versions of Terraform</li><li><code>tfv ls-remote</code>: List all available versions of Terraform</li><li><code>tfv set &lt;version></code>: Set the active version of Terraform</li><li><code>tfv unset</code>: Unset the active version of Terraform</li><li><code>tfv help</code>: Show the help message</li></ul><h2 id=next-steps>Next Steps
<a class=heading-link href=#next-steps><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>If you want to take this even further, here are a few ideas:</p><ul><li>Add support for Linux and Mac</li><li>Add support for other HashiCorp tools (e.g. Packer, Vault, Consul)</li><li>Add support for other tools (e.g. kubectl, helm, az, aws)</li></ul><h2 id=plans-for-the-future>Plans for the Future
<a class=heading-link href=#plans-for-the-future><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I am working on providing this as a fully-functional and cross-platform PowerShell module available on the PowerShell Gallery. You can check out the <a href=https://github.com/mikesigs/tfv class=external-link target=_blank rel=noopener>GitHub repo</a> to see the current progress and submit a Pull Request if you&rsquo;d like to help out. I welcome any contributions and feedback to make this tool even better!</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//discardchanges.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2023
Mike Sigsworth
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>